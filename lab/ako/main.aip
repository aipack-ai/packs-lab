# Before All

```lua
local p_utils = require("prompt_utils")

-- 
local LABEL_FETCH_SLIM = "   Fetch & Slim Agent:"
local LABEL_AUGMENT    = "Clean & Augment Agent:"
local LABEL_LLMS       = "     llms Index Agent:"
local LABEL_DOCAIFY    = "        Docaify Agent:"
local LABEL_SUMMARY    = "              Summary:"

local LABEL_SUM_FROM_ORG = "        From Original HTMLs size: "
local LABEL_SUM_AI_MD    = "   To AI Optimized Markdown size: "
local LABEL_SUM_DOCAIFY  = "                 To docaify size: "

-- Get the first input (optional name of the config file) or nil
local input = inputs and inputs[1] or nil

-- Run setup (validates version, initializes config, creates README if needed)
local setup_info = p_utils.setup(input)

if setup_info.type == "skip" then
  return aip.flow.skip(setup_info.skip_reason)
end

if setup_info.type == "message" then
  local msg = setup_info.message .. "\n\n(Alt click on the file path above to open the file in your editor)"
  aip.run.pin("msg", 0, { label = "Action Needed:", content = msg} )
  return {
    setup_info = setup_info
  }
end

if setup_info.type == "ready" then
  local config = setup_info.config
  local settings = setup_info.settings

  aip.run.pin("fetch-slim", 0, { label = LABEL_FETCH_SLIM, content = "⏸ Queued"})
  aip.run.pin("augm", 1,       { label = LABEL_AUGMENT, content = "⏸ Queued"})
  aip.run.pin("llms", 2,       { label = LABEL_LLMS, content = "⏸ Queued"})
  aip.run.pin("docaify", 3,    { label = LABEL_DOCAIFY, content = "⏸ Queued"})

  -- == Run Slim
  aip.run.pin("fetch-slim", 0, { label = LABEL_FETCH_SLIM, content = "▶ Running"})

  local slim_msg = ""
  local num_of_files = nil
  local orig_html_total_size = nil
  local raw_md_total_size = nil
  -- We perform the fetch & slim
  if config.do_fetch_slim == nil or config.do_fetch_slim == true then
    local slim_data      = aip.agent.run("fetch-slim", {inputs = { config.config_path } }).after_all
    num_of_files         = slim_data.num_of_files
    orig_html_total_size = slim_data.orig_html_total_size
    raw_md_total_size    = slim_data.raw_md_total_size
  -- We skip the fetch & slim
  end

  -- If we do not have a num_of_files (when do_fetch_slim == false ) or was 0
  -- Might still have files to be processed
  if num_of_files == nil or num_of_files == 0 then
    local orig_stats     = aip.file.stats(settings.dir_0_original .. "/**/*")
    local raw_stats      = aip.file.stats(settings.dir_2_raw_md .. "/**/*")
    num_of_files         = raw_stats.number_of_files -- this way allows to just use the augment 
    orig_html_total_size = orig_stats.total_size
    raw_md_total_size    = raw_stats.total_size
    slim_msg = "■■ SKIP ➜ " .. slim_msg
  else 
    slim_msg = "✅ DONE ➜ " .. slim_msg
  end
  
  
  slim_msg = slim_msg .. num_of_files .. " pages processed."
  slim_msg = slim_msg .. " " .. aip.text.format_size(orig_html_total_size, {trim = true})
  slim_msg = slim_msg .. " ➜ " .. aip.text.format_size(raw_md_total_size, {trim = true})
  aip.run.pin("fetch-slim", 0, { label = LABEL_FETCH_SLIM, content = slim_msg})

  if num_of_files == 0 then
    -- ✖
    aip.run.pin("augm", 1, { label = LABEL_AUGMENT, content = "✖ Canceled, no files to process."})
    aip.run.pin("llms", 1, { label = LABEL_LLMS, content = "✖ Canceled, no files to process."})
    return
  end
  
  -- == Run Augment
  local augment_msg = nil

  if config.do_augment == nill or config.do_augment == true then 
    aip.run.pin("augm", 1, { label = LABEL_AUGMENT, content = "▶ Running"})

    local augment_data = aip.agent.run("clean-augment", {inputs = { config.config_path } }).after_all
    augment_msg = "✅ DONE ➜ " .. augment_data.processed_count .. " AI Augmented"
    if num_of_files then
        local already_processed_count = num_of_files - augment_data.processed_count - (augment_data.skipped_count or 0)
        if already_processed_count > 0 then 
            augment_msg = augment_msg .. " - " .. already_processed_count .. " already processed."
        end
    end
    augment_msg = augment_msg .. " " .. aip.text.trim(augment_data.raw_size_fmt) .. " ➜ " .. aip.text.trim(augment_data.final_size_fmt)
  else
    augment_msg = "■■ SKIP ➜ " .. "(do_augment = false)"
  end

  aip.run.pin("augm", 1, { label = LABEL_AUGMENT, content = augment_msg })

  -- == Run llms
  if settings.config.do_llms == nil or settings.config.do_llms == true then 
     aip.run.pin("llms", 2, { label = LABEL_LLMS, content = "▶ Running"})
     
     local llms_data = aip.agent.run("llms-index", {inputs = { config.config_path } }).after_all
     local llms_size_fmt = aip.text.format_size(llms_data.llms_size, { trim = true})
     local llms_msg = "✅ DONE ➜ " .. llms_data.llms_path .. " (" .. llms_size_fmt .. ")"
     
     aip.run.pin("llms", 2,  { label = LABEL_LLMS, content = llms_msg})
  else
     local llms_msg = "■■ SKIP ➜ " .. "(do_llms = false or no files to llms)"
     aip.run.pin("llms", 2,  { label = LABEL_LLMS, content = llms_msg})
  end

  -- == Run docaify
  if settings.config.do_docaify == nil or settings.config.do_docaify == true then 
     aip.run.pin("docaify", 3, { label = LABEL_DOCAIFY, content = "▶ Running"})
     
     local docaify_data = aip.agent.run("docaify", {inputs = { config.config_path } }).after_all
     local docaify_size_fmt = aip.text.format_size(docaify_data.docaify_size, { trim = true})
     local docaify_msg = "✅ DONE ➜ " .. docaify_data.docaify_path .. " (" .. docaify_size_fmt .. ")"
     
     aip.run.pin("docaify", 3,  { label = LABEL_DOCAIFY, content = docaify_msg})
  else
     local docaify_msg = "■■ SKIP ➜ " .. "(do_docaify = false)"
     aip.run.pin("docaify", 3,  { label = LABEL_DOCAIFY, content = docaify_msg})
  end

  -- == Pin final summary (after docaify)
  local original_size_fmt = aip.text.format_size(orig_html_total_size, "MB")
  local final_size = aip.file.stats(settings.dir_4_final_md .. "/**/*.*").total_size
  local final_size_fmt = aip.text.format_size(final_size, "MB")
  if final_size < 1000000 then
    local full_size_fmt = aip.text.format_size(final_size, { trim = true})
    final_size_fmt = final_size_fmt .. " (" .. full_size_fmt .. ")"
  end

  -- Get docaify file size if it exists
  local docaify_size_fmt = nil
  local docaify_target_path = settings.config.docaify_target_path
  
  local docaify_path
  
  if docaify_target_path then
    docaify_target_path = p_utils.resolve_target_path(docaify_target_path, settings)
    
    if docaify_target_path:match("%.md$") then
      docaify_path = docaify_target_path
    else
      local base_data_dir_obj = aip.path.parse(settings.base_data_dir)
      local lib_name = base_data_dir_obj.stem or "lib"
      docaify_path = docaify_target_path .. "/" .. lib_name .. "-doc-for-llm.md"
    end
  else
    docaify_path = settings.dir_5_docaify .. "/doc-for-llm.md"
  end
  if aip.path.exists(docaify_path) then
    local docaify_info = aip.file.info(docaify_path)
    if docaify_info and docaify_info.size then
      docaify_size_fmt = aip.text.format_size(docaify_info.size, "MB")
      if docaify_info.size < 1000000 then
        local full_docaify_size_fmt = aip.text.format_size(docaify_info.size, { trim = true})
        docaify_size_fmt = docaify_size_fmt .. " (" .. full_docaify_size_fmt .. ")"
      end
    end
  end

  local final_msg = "✅ ALL DONE"
  final_msg = final_msg .. "\n" .. LABEL_SUM_FROM_ORG .. original_size_fmt
  final_msg = final_msg .. "\n" .. LABEL_SUM_AI_MD .. final_size_fmt .. " including llms.md"
  if docaify_size_fmt then
    final_msg = final_msg .. "\n" .. LABEL_SUM_DOCAIFY .. docaify_size_fmt
  end

  aip.run.pin("final", 4, { label = LABEL_SUMMARY, content = final_msg})
else 
  print("setup_info type unknown", setup_info.type)
end


-- return aip.flow.before_all_response({
--   before_all = { "one", "two" }
-- })

```


# After All

```lua
-- print("slim agent\n50 files slimmed")
-- 
-- print("agument agent\n[ ] [ ] [ ]")
-- 
-- print("before_all",before_all)

return "Done"

```